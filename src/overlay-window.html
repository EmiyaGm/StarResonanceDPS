<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPSÊÇ¨ÊµÆÁ™ó</title>
    <link rel="stylesheet" href="overlay-window.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
    <div class="overlay-container">
        <!-- ÊÇ¨ÊµÆÁ™óÂ§¥ÈÉ®ÔºàÂèØÊãñÊãΩÔºâ -->
        <div class="overlay-header" id="overlayHeader">
            <div class="overlay-title">
                <span class="overlay-icon">‚ö°</span>
                <span class="title-text">DPSÁõëÊéß</span>
            </div>
            <div class="overlay-controls">
                <button class="overlay-control-btn pin-btn" id="pinBtn" title="ÂàáÊç¢ÁΩÆÈ°∂">
                    <span>üìå</span>
                </button>
                <button class="overlay-control-btn settings-btn" id="settingsBtn" title="ËÆæÁΩÆ">
                    <span>‚öôÔ∏è</span>
                </button>
                <button class="overlay-control-btn minimize-btn" id="minimizeBtn" title="ÊúÄÂ∞èÂåñ">
                    <span>‚Äì</span>
                </button>
                <button class="overlay-control-btn close-btn" id="closeBtn" title="ÂÖ≥Èó≠">
                    <span>‚úï</span>
                </button>
            </div>
        </div>

        <!-- DPSÊï∞ÊçÆÊòæÁ§∫Âå∫Âüü -->
        <div class="overlay-content">
            <!-- ‰∏ªË¶ÅDPSÊåáÊ†á -->
            <div class="dps-main">
                <div class="dps-item primary">
                    <div class="dps-label">ÂÆûÊó∂DPS</div>
                    <div class="dps-value" id="realtimeDps">0</div>
                    <div class="dps-bar">
                        <div class="dps-bar-fill" id="realtimeDpsBar"></div>
                    </div>
                </div>
                
                <div class="dps-item secondary">
                    <div class="dps-label">Â≥∞ÂÄºDPS</div>
                    <div class="dps-value" id="maxDps">0</div>
                    <div class="dps-bar">
                        <div class="dps-bar-fill max" id="maxDpsBar"></div>
                    </div>
                </div>
                
                <div class="dps-item tertiary">
                    <div class="dps-label">Âπ≥ÂùáDPS</div>
                    <div class="dps-value" id="avgDps">0</div>
                    <div class="dps-bar">
                        <div class="dps-bar-fill avg" id="avgDpsBar"></div>
                    </div>
                </div>
            </div>

            <!-- ËØ¶ÁªÜÁªüËÆ°ÔºàÂèØÊäòÂè†Ôºâ -->
            <div class="dps-details" id="dpsDetails">
                <div class="details-header" id="detailsToggle">
                    <span class="details-title">ËØ¶ÁªÜÁªüËÆ°</span>
                    <span class="details-arrow">‚ñº</span>
                </div>
                <div class="details-content" id="detailsContent">
                    <div class="detail-row">
                        <span class="detail-label">ÊÄª‰º§ÂÆ≥</span>
                        <span class="detail-value" id="totalDamage">0</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Êö¥ÂáªÁéá</span>
                        <span class="detail-value" id="critRate">0%</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">ÊîªÂáªÊ¨°Êï∞</span>
                        <span class="detail-value" id="attackCount">0</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Áé©ÂÆ∂UID</span>
                        <span class="detail-value" id="playerUid">Êú™Ê£ÄÊµã</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ËÆæÁΩÆÈù¢ÊùøÔºàÈöêËóèÔºâ -->
        <div class="overlay-settings" id="overlaySettings" style="display: none;">
            <div class="settings-header">
                <h4>ÊÇ¨ÊµÆÁ™óËÆæÁΩÆ</h4>
                <button class="close-settings-btn" id="closeSettingsBtn">‚úï</button>
            </div>
            <div class="settings-content">
                <div class="setting-item">
                    <label>ÈÄèÊòéÂ∫¶</label>
                    <input type="range" id="opacitySlider" min="30" max="100" value="90" step="10">
                    <span id="opacityValue">90%</span>
                </div>
                <div class="setting-item">
                    <label>Êõ¥Êñ∞È¢ëÁéá</label>
                    <select id="updateFrequency">
                        <option value="100">100ms (ÊµÅÁïÖ)</option>
                        <option value="250" selected>250ms (Âπ≥Ë°°)</option>
                        <option value="500">500ms (ËäÇËÉΩ)</option>
                    </select>
                </div>
                <div class="setting-item">
                    <label class="checkbox-label">
                        <input type="checkbox" id="showDetailsDefault" checked>
                        <span class="checkbox-custom"></span>
                        ÈªòËÆ§ÊòæÁ§∫ËØ¶ÁªÜÁªüËÆ°
                    </label>
                </div>

            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');

        let statsData = {};
        let detailsExpanded = true;
        let updateInterval = null;
        let updateFreency = 500; // ÈªòËÆ§Èôç‰ΩéÊõ¥Êñ∞È¢ëÁéá‰ª•ËäÇÁúÅÊÄßËÉΩ
        let opacity = 90;
        let isPinned = true;

        // DOMÂÖÉÁ¥†
        let realtimeDps, maxDps, avgDps, totalDamage, critRate, attackCount, playerUid;
        let realtimeDpsBar, maxDpsBar, avgDpsBar;
        let pinBtn, settingsBtn, minimizeBtn, closeBtn, detailsToggle, detailsContent;
        let overlaySettings, closeSettingsBtn, opacitySlider, opacityValue, updateFrequencySelect;
        let showDetailsDefaultCheckbox;

        // ÂàùÂßãÂåñ
        function initializeOverlay() {
            // Ëé∑ÂèñDOMÂÖÉÁ¥†
            realtimeDps = document.getElementById('realtimeDps');
            maxDps = document.getElementById('maxDps');
            avgDps = document.getElementById('avgDps');
            totalDamage = document.getElementById('totalDamage');
            critRate = document.getElementById('critRate');
            attackCount = document.getElementById('attackCount');
            playerUid = document.getElementById('playerUid');
            
            // Ë∞ÉËØïÔºöÊ£ÄÊü•DOMÂÖÉÁ¥†ÊòØÂê¶Ê≠£Á°ÆËé∑Âèñ
            console.log('ÊÇ¨ÊµÆÁ™óDOMÂÖÉÁ¥†ÂàùÂßãÂåñ:', {
                playerUid: playerUid,
                playerUidExists: !!playerUid
            });
            
            realtimeDpsBar = document.getElementById('realtimeDpsBar');
            maxDpsBar = document.getElementById('maxDpsBar');
            avgDpsBar = document.getElementById('avgDpsBar');
            
            pinBtn = document.getElementById('pinBtn');
            settingsBtn = document.getElementById('settingsBtn');
            minimizeBtn = document.getElementById('minimizeBtn');
            closeBtn = document.getElementById('closeBtn');
            detailsToggle = document.getElementById('detailsToggle');
            detailsContent = document.getElementById('detailsContent');
            
            overlaySettings = document.getElementById('overlaySettings');
            closeSettingsBtn = document.getElementById('closeSettingsBtn');
            opacitySlider = document.getElementById('opacitySlider');
            opacityValue = document.getElementById('opacityValue');
            updateFrequencySelect = document.getElementById('updateFrequency');
            showDetailsDefaultCheckbox = document.getElementById('showDetailsDefault');

            bindEvents();
            loadSettings();
            updatePinButton();
            
            // Á°Æ‰øùËØ¶ÁªÜÁªüËÆ°ÈªòËÆ§Â±ïÂºÄ
            if (detailsContent) {
                detailsContent.style.display = detailsExpanded ? 'block' : 'none';
                const arrow = document.querySelector('.details-arrow');
                if (arrow) {
                    arrow.textContent = detailsExpanded ? '‚ñº' : '‚ñ∂';
                }
                console.log('ËØ¶ÁªÜÁªüËÆ°Â±ïÂºÄÁä∂ÊÄÅ:', detailsExpanded);
            }
            
            startDataUpdate();
        }

        // ÁªëÂÆö‰∫ã‰ª∂
        function bindEvents() {
            // ÁΩÆÈ°∂ÊåâÈíÆ
            pinBtn.addEventListener('click', () => {
                isPinned = !isPinned;
                ipcRenderer.invoke('overlay-set-always-on-top', isPinned);
                updatePinButton();
            });

            // ÊéßÂà∂ÊåâÈíÆ
            settingsBtn.addEventListener('click', () => {
                overlaySettings.style.display = overlaySettings.style.display === 'none' ? 'block' : 'none';
            });

            minimizeBtn.addEventListener('click', () => {
                ipcRenderer.invoke('overlay-minimize');
            });

            closeBtn.addEventListener('click', () => {
                ipcRenderer.invoke('overlay-close');
            });

            // ËØ¶ÁªÜÁªüËÆ°ÊäòÂè†
            detailsToggle.addEventListener('click', () => {
                detailsExpanded = !detailsExpanded;
                detailsContent.style.display = detailsExpanded ? 'block' : 'none';
                document.querySelector('.details-arrow').textContent = detailsExpanded ? '‚ñº' : '‚ñ∂';
            });

            // ËÆæÁΩÆÈù¢Êùø
            closeSettingsBtn.addEventListener('click', () => {
                overlaySettings.style.display = 'none';
            });

            // ÈÄèÊòéÂ∫¶ËÆæÁΩÆ
            opacitySlider.addEventListener('input', (e) => {
                opacity = parseInt(e.target.value);
                opacityValue.textContent = opacity + '%';
                document.body.style.opacity = opacity / 100;
                saveSettings();
            });

            // Êõ¥Êñ∞È¢ëÁéáËÆæÁΩÆ
            updateFrequencySelect.addEventListener('change', (e) => {
                updateFreency = parseInt(e.target.value);
                restartDataUpdate();
                saveSettings();
            });

            // ÈªòËÆ§ÊòæÁ§∫ËØ¶ÁªÜÁªüËÆ°
            showDetailsDefaultCheckbox.addEventListener('change', (e) => {
                detailsExpanded = e.target.checked;
                detailsContent.style.display = detailsExpanded ? 'block' : 'none';
                document.querySelector('.details-arrow').textContent = detailsExpanded ? '‚ñº' : '‚ñ∂';
                saveSettings();
            });



            // Êé•Êî∂Êï∞ÊçÆÊõ¥Êñ∞
            ipcRenderer.on('stats-updated', (event, data) => {
                statsData = data;
                updateDpsDisplay();
            });

            // Êé•Êî∂Áé©ÂÆ∂UIDÊõ¥Êñ∞
            ipcRenderer.on('player-uid-updated', (event, uid) => {
                console.log('ÊÇ¨ÊµÆÁ™óÊî∂Âà∞UIDÊõ¥Êñ∞‰∫ã‰ª∂:', {
                    uid: uid,
                    playerUidElement: playerUid,
                    playerUidExists: !!playerUid
                });
                
                if (playerUid) {
                    playerUid.textContent = uid || 'Êú™Ê£ÄÊµã';
                    console.log('UIDÂ∑≤Êõ¥Êñ∞Âà∞ÊÇ¨ÊµÆÁ™óÔºåÂΩìÂâçÊòæÁ§∫:', playerUid.textContent);
                } else {
                    console.error('playerUid DOMÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºÅ');
                }
            });
        }

        // ÂºÄÂßãÊï∞ÊçÆÊõ¥Êñ∞
        function startDataUpdate() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            updateInterval = setInterval(() => {
                ipcRenderer.invoke('get-stats-data').then(data => {
                    if (data) {
                        statsData = data;
                        updateDpsDisplay();
                    }
                });
            }, updateFreency);

            // Ëé∑ÂèñÂΩìÂâçÁé©ÂÆ∂UID
            console.log('ÊÇ¨ÊµÆÁ™óÂºÄÂßãËé∑ÂèñÂΩìÂâçUID...');
            ipcRenderer.invoke('get-player-uid').then(uid => {
                console.log('ÊÇ¨ÊµÆÁ™óget-player-uidÂìçÂ∫î:', {
                    uid: uid,
                    hasUid: !!uid,
                    playerUidElement: playerUid,
                    playerUidExists: !!playerUid
                });
                
                if (uid && playerUid) {
                    playerUid.textContent = uid;
                    console.log('ÊÇ¨ÊµÆÁ™ó‰∏ªÂä®Ëé∑ÂèñUIDÊàêÂäüÔºåËÆæÁΩÆ‰∏∫:', uid);
                } else if (!uid) {
                    console.log('ÂΩìÂâçÊ≤°ÊúâÁé©ÂÆ∂UIDÊï∞ÊçÆ');
                } else if (!playerUid) {
                    console.error('playerUid DOMÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºÅ');
                }
            }).catch(err => {
                console.error('Ëé∑ÂèñÁé©ÂÆ∂UIDÂ§±Ë¥•:', err);
            });
        }

        // ÈáçÂêØÊï∞ÊçÆÊõ¥Êñ∞
        function restartDataUpdate() {
            startDataUpdate();
        }

        // Êõ¥Êñ∞DPSÊòæÁ§∫
        function updateDpsDisplay() {
            const userIds = Object.keys(statsData);
            
            if (userIds.length === 0) {
                // Êó†Êï∞ÊçÆÊó∂ÊòæÁ§∫0
                realtimeDps.textContent = '0';
                maxDps.textContent = '0';
                avgDps.textContent = '0';
                totalDamage.textContent = '0';
                critRate.textContent = '0%';
                attackCount.textContent = '0';
                updateProgressBars(0, 0, 0);
                return;
            }

            // ËÆ°ÁÆóÊÄª‰ΩìÊï∞ÊçÆ
            let totalRealtimeDpsValue = 0;
            let totalMaxDpsValue = 0;
            let totalAvgDpsValue = 0;
            let totalDamageValue = 0;
            let totalCritCount = 0;
            let totalAttackCount = 0;

            for (const uid of userIds) {
                const userData = statsData[uid];
                totalRealtimeDpsValue += userData.realtime_dps || 0;
                totalMaxDpsValue = Math.max(totalMaxDpsValue, userData.realtime_dps_max || 0);
                totalAvgDpsValue += userData.total_dps || 0;
                totalDamageValue += userData.total_damage.total || 0;
                totalCritCount += userData.total_count.critical || 0;
                totalAttackCount += userData.total_count.total || 0;
            }

            if (userIds.length > 0) {
                totalAvgDpsValue = totalAvgDpsValue / userIds.length;
            }

            const critRateValue = totalAttackCount > 0 ? (totalCritCount / totalAttackCount) : 0;

            // Êõ¥Êñ∞ÊòæÁ§∫
            realtimeDps.textContent = formatNumber(totalRealtimeDpsValue);
            maxDps.textContent = formatNumber(totalMaxDpsValue);
            avgDps.textContent = formatNumber(totalAvgDpsValue);
            totalDamage.textContent = formatNumber(totalDamageValue);
            critRate.textContent = (critRateValue * 100).toFixed(1) + '%';
            attackCount.textContent = totalAttackCount.toString();

            // Êõ¥Êñ∞ËøõÂ∫¶Êù°
            updateProgressBars(totalRealtimeDpsValue, totalMaxDpsValue, totalAvgDpsValue);
        }

        // Êõ¥Êñ∞ËøõÂ∫¶Êù°
        function updateProgressBars(realtime, max, avg) {
            const maxValue = Math.max(realtime, max, avg) || 1;
            
            const realtimePercent = (realtime / maxValue) * 100;
            const maxPercent = (max / maxValue) * 100;
            const avgPercent = (avg / maxValue) * 100;
            
            realtimeDpsBar.style.width = `${Math.min(realtimePercent, 100)}%`;
            maxDpsBar.style.width = `${Math.min(maxPercent, 100)}%`;
            avgDpsBar.style.width = `${Math.min(avgPercent, 100)}%`;
        }

        // Ê†ºÂºèÂåñÊï∞Â≠ó
        function formatNumber(num) {
            if (typeof num !== 'number' || isNaN(num)) return '0';
            
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            } else {
                return Math.floor(num).toString();
            }
        }

        // Êõ¥Êñ∞ÁΩÆÈ°∂ÊåâÈíÆÁä∂ÊÄÅ
        function updatePinButton() {
            if (pinBtn) {
                const pinIcon = pinBtn.querySelector('span');
                if (isPinned) {
                    pinIcon.textContent = 'üìå';
                    pinBtn.style.background = 'rgba(255, 255, 255, 0.3)';
                    pinBtn.title = 'ÁÇπÂáªÂèñÊ∂àÁΩÆÈ°∂';
                } else {
                    pinIcon.textContent = 'üìç';
                    pinBtn.style.background = 'rgba(255, 255, 255, 0.1)';
                    pinBtn.title = 'ÁÇπÂáªÁΩÆÈ°∂ÊòæÁ§∫';
                }
            }
        }

        // ‰øùÂ≠òËÆæÁΩÆ
        function saveSettings() {
            const settings = {
                opacity,
                updateFreency,
                detailsExpanded,
                isPinned
            };
            localStorage.setItem('overlaySettings', JSON.stringify(settings));
        }

        // Âä†ËΩΩËÆæÁΩÆ
        function loadSettings() {
            try {
                const settings = JSON.parse(localStorage.getItem('overlaySettings') || '{}');
                
                if (settings.opacity !== undefined) {
                    opacity = settings.opacity;
                    opacitySlider.value = opacity;
                    opacityValue.textContent = opacity + '%';
                    document.body.style.opacity = opacity / 100;
                }
                
                if (settings.updateFreency !== undefined) {
                    updateFreency = settings.updateFreency;
                    updateFrequencySelect.value = updateFreency;
                }
                
                if (settings.detailsExpanded !== undefined) {
                    detailsExpanded = settings.detailsExpanded;
                    showDetailsDefaultCheckbox.checked = detailsExpanded;
                    detailsContent.style.display = detailsExpanded ? 'block' : 'none';
                    document.querySelector('.details-arrow').textContent = detailsExpanded ? '‚ñº' : '‚ñ∂';
                }
                
                if (settings.isPinned !== undefined) {
                    isPinned = settings.isPinned;
                    ipcRenderer.invoke('overlay-set-always-on-top', isPinned);
                    updatePinButton();
                }
            } catch (error) {
                console.error('Âä†ËΩΩËÆæÁΩÆÂ§±Ë¥•:', error);
            }
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', initializeOverlay);

        // È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜ
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
            // Ê∏ÖÁêÜÊï∞ÊçÆÂºïÁî®
            statsData = null;
        });
    </script>
</body>
</html>